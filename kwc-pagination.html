<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../kwc-style/typography.html">

<dom-module id="kwc-pagination">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                user-select: none;
            }

            :host * {
                font-family: var(--font-body);
                font-size: 16px;
                font-weight: bold;
            }

            :host *:focus {
                outline: none;
            }

            .step,
            .full-step {
                border: none;
                background: transparent;
                color: #9FA4A8;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .step:not([disabled]):hover,
            .full-step:not([disabled]):hover {
                color: #414A51;
            }

            .full-step:not([disabled]):hover svg {
                fill: #414A51;
            }

            .step svg {
                fill: #FFF;
            }

            .full-step svg {
                fill: #9FA4A8;
            }

            .step span {
                width: 24px;
                height: 24px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background: #9FA4A8;
                border-radius: 50%;
                margin: 0 8px;
                transition: all 0.15s ease;
            }

            .step:not([disabled]):hover span {
                background: #FF6900;
            }

            .item {
                color: #9FA4A8;
                background: transparent;
                min-width: 32px;
                height: 32px;
                padding: 0 0.747em;
                border: none;
                border-radius: 16px;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .item:hover {
                background: #414A51;
                color: #FFF;
            }

            .item[active] {
                background: #9FA4A8;
                color: #FFF;
            }

            .rotate_180 {
                transform: rotate(180deg);
            }

            @media all and (max-width: 680px) {
                :host {
                    @apply --layout-horizontal;
                    @apply --layout-wrap;
                    @apply --layout-center;
                    @apply --layout-center-justified;
                }

                .item {
                    display: none;
                }
            }

            [disabled],
            [disabled],
            [disabled]:hover,
            [disabled]:focus {
                opacity: 0.5;
                cursor: initial;
            }

            [hidden] {
                display: none;
            }
        </style>

        <div class="prev-content">
            <template is="dom-if" if="[[jumpControls]]">
                <button class="full-step rotate_180" inner-h-t-m-l="[[doubleArrow]]" on-tap="_goToFirstPage" disabled$="[[_isFirstPage(currentPage, totalPages)]]"></button>
            </template>

            <template is="dom-if" if="[[paginationControls]]">
                <button class="step" on-tap="_previousPage" disabled$="[[_isFirstPage(currentPage, totalPages)]]">
                    <span class="rotate_180" inner-h-t-m-l="[[singleArrow]]"></span>Prev
                </button>
            </template>
        </div>
        <div class="items-content">
            <template is="dom-repeat" items="[[_pages]]">
                <button class="item" active$="[[_isActive(item, currentPage)]]" on-tap="_goToPage">
                    <span>[[item]]</span>
                </button>
            </template>
        </div>
        <div class="next-content">
            <template is="dom-if" if="[[paginationControls]]">
                <button class="step" on-tap="_nextPage" disabled$="[[_isLastPage(currentPage, totalPages)]]">
                    Next<span inner-h-t-m-l="[[singleArrow]]"></span>
                </button>
            </template>

            <template is="dom-if" if="[[jumpControls]]">
                <button class="full-step" inner-h-t-m-l="[[doubleArrow]]" on-tap="_goToLastPage" disabled$="[[_isLastPage(currentPage, totalPages)]]"></button>
            </template>
        </div>
    </template>

    <script>
        class KWCPagination extends Polymer.GestureEventListeners(Polymer.Element) {
            static get is() { return 'kwc-pagination'; }
            static get properties() {
                return {
                    /**
                     * Set what is the number to start counting from for page
                     * labels.
                     */
                    startsOn: {
                        type: Number,
                        value: 1
                    },
                    /**
                     * Total amount of pages to paginate.
                     * @type {Number}
                     */
                    totalPages: {
                        type: Number,
                        value: 1
                    },
                    /**
                     * Which page is currently selected.
                     * @type {Number}
                     */
                    currentPage: {
                        type: Number,
                        value: 1
                    },
                    /**
                     * How many pages to display between the control buttons.
                     * @type {Number}
                     */
                    range: {
                        type: Number,
                        value: 3
                    },
                    /**
                     * Flags if pagination should display controls for "next"
                     * and "previous" pages.
                     * @type {Boolean}
                     */
                    paginationControls: {
                        type: Boolean,
                        default: false
                    },
                    /**
                     * Flags if pagination should display controls for "jump to
                     * first" and "jump to last" pages.
                     * @type {Boolean}
                     */
                    jumpControls: {
                        type: Boolean,
                        default: false
                    },
                    /**
                     * Array of page indexes to be displayed, calculated based
                     * on the `totalPages`, `range` and the `currentPage`.
                     * @type {Array}
                     */
                    _pages: {
                        type: Array,
                        computed: '_computePages(currentPage, totalPages, range)'
                    },
                }
            }
            connectedCallback() {
                super.connectedCallback();
                this.initIcons();
            }
            _computePages(currentPage, totalPages, range) {
                totalPages = (totalPages || 1);
                let pages = [],
                    startsOn = this.startsOn;

                if (totalPages <= range) {
                    /**
                     * The amount of pages is smaller than the range:
                     * add as many pages as there are
                     */
                    for (let i = startsOn; i < totalPages + startsOn; i++) {
                        pages.push(i);
                    }
                } else {
                    /**
                     * The amount of pages is bigger than the range:
                     * only show a number of pages equal to the range
                     *
                     * If current page is not on the last pages
                     */
                    if (currentPage < (startsOn + totalPages - range)) {
                        /**
                         * Current page is in the middle of pagination
                         */
                        let initCount = currentPage - parseInt(range / 2);
                        if (initCount < startsOn) {
                            initCount = startsOn;
                        }
                        for (let i = initCount; i < initCount + range; i++) {
                            pages.push(i);
                        }
                    } else {
                        /**
                         * Current page is on the final pages
                         */
                        let initCount = startsOn + totalPages - range;
                        for (let i = initCount; i < totalPages + startsOn; i++) {
                            pages.push(i);
                        }
                    }
                }
                return pages;
            }
            /**
             * Triggered to notify an intent to navigate to a page (from the
             * available pages on the navigation).
             * @event go-to-page
             * @param {Object} e Object containing information if the event
             *     should bubble up (`bubbles`) and the page index intended
             *    (`detail`).
             */
            /**
             * Dispath event to notify intent to navigate to a specific page
             * @param {Event} e Event triggered by tapping a page button.
             */
            _goToPage(e) {
                let page = parseInt(e.model.item);
                this.dispatchEvent(new CustomEvent(
                    'go-to-page', { bubbles: false, detail: page }
                ));
            }
            /**
             * Dispath event to notify intent to navigate to the next page
             * @param {Event} e Event triggered by tapping a page button.
             */
            _nextPage(e) {
                let page = parseInt(this.currentPage);
                this.dispatchEvent(new CustomEvent(
                    'go-to-page', { bubbles: false, detail: page + 1 }
                ));
            }
            /**
             * Dispath event to notify intent to navigate to the previous page
             * @param {Event} e Event triggered by tapping a page button.
             */
            _previousPage(e) {
                let page = parseInt(this.currentPage);
                this.dispatchEvent(new CustomEvent(
                    'go-to-page', { bubbles: false, detail: page - 1 }
                ));
            }
            /**
             * Dispath event to notify intent to navigate to the jump to the
             * last page.
             * @param {Event} e Event triggered by tapping a page button.
             */
            _goToLastPage() {
                this.dispatchEvent(new CustomEvent(
                    'go-to-page', { bubbles: false, detail: this.totalPages + this.startsOn - 1 }
                ));
            }
            /**
             * Dispath event to notify intent to navigate to the jump to the
             * first page.
             * @param {Event} e Event triggered by tapping a page button.
             */
            _goToFirstPage() {
                this.dispatchEvent(new CustomEvent(
                    'go-to-page', { bubbles: false, detail: this.startsOn }
                ));
            }
            /**
             * Calculates if the given page is the currently selected/active
             * @param {Number} page Page to check if it's selected/active
             * @return {Boolean}
             */
            _isActive(page) {
                return page == this.currentPage;
            }
            /**
             * Calculates if the current page is the first page.
             * @return {Boolean}
             */
            _isFirstPage() {
                // If there are pages, check if it's the first
                if (this.totalPages > 1) {
                    return parseInt(this.currentPage) == this.startsOn;
                } else {
                    // Return true to disable the "previous" and "first page"
                    // buttons on the navigation
                    return true;
                }
            }
            /**
             * Calculates if the current page is the last page.
             * @return {Boolean}
             */
            _isLastPage() {
                if (this.totalPages > 1) {
                    return parseInt(this.currentPage) == this.totalPages + this.startsOn - 1;
                } else {
                    return true;
                }
            }
            initIcons() {
                this.singleArrow = `<svg width="7" height="11" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(0.02705042571984343,0,0,0.02705042571984343,4.178148809049535,4.258132582494917)" id="svg_3" stroke="null"><path d="m86.40322,72.38476a559.83453,559.83453 0 0 1 -135.22157,159.33752c-95.17187,72.77849 -95.17187,-185.60668 -95.17187,-185.60668s0,-258.81581 95.17187,-186.03732a559.83453,559.83453 0 0 1 135.22157,159.33752a50.81575,50.81575 0 0 1 0,52.96896z" id="svg_2" stroke="null" /></g></svg>`;
                this.doubleArrow = `<svg width="16" height="11" xmlns="http://www.w3.org/2000/svg"><g stroke="null" transform="matrix(1.1530202929558453,0,0,1.1530202929558453,-1.1784392004728186,-0.8169220210118078) "id="svg_5"><path stroke="null" id="svg_8" d="m14.524191,6.132488a13,13 0 0 1 -3.14,3.7c-2.21,1.69 -2.21,-4.31 -2.21,-4.31s0,-6 2.21,-4.32a13,13 0 0 1 3.14,3.7a1.18,1.18 0 0 1 0,1.23z" /><path stroke="null" id="svg_9" d="m6.524191,6.132488a13,13 0 0 1 -3.14,3.7c-2.21,1.69 -2.21,-4.31 -2.21,-4.31s0,-6.01 2.21,-4.32a13,13 0 0 1 3.14,3.7a1.18,1.18 0 0 1 0,1.23z" /></g></svg>`;
            }
        }
        window.customElements.define(KWCPagination.is, KWCPagination);
    </script>
</dom-module>